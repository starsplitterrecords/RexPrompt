<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Assembler</title>
<style>
body { font-family: sans-serif; padding: 20px; }
select, button { margin: 0 10px 20px 0; }
pre { background:#eee; padding:10px; white-space:pre-wrap; }
.block { margin-bottom:15px; }
</style>
</head>
<body>

<h3>Assembler</h3>

<div class="block">
  <label>Scene (recipes)</label>
  <select id="sceneSel"></select>
</div>

<button id="buildBtn">Build</button>

<pre id="out"></pre>

<div id="manualInputs"></div>



<script>
const files = [
  "blocking.json",
  "characters.json",
  "dialogue.json",
  "direction.json",
  "factions.json",
  "lighting.json",
  "mood.json",
  "negatives.json",
  "regions.json",
  "settings.json",
  "scenes_prequel.json"
];

async function load(path) {
  const r = await fetch("data/" + path);
  if (!r.ok) throw new Error("load fail: " + path);
  return r.json();
}

function getHandle(charId, charactersJson) {
  const entry = charactersJson[charId];
  return entry ? entry.handle || entry.name || charId : charId;
}

function formatEntry(e) {
  if (typeof e === "string") return e;
  if (e.text) return e.text;
  if (e.name) return e.name;
  if (e.summary) return e.summary;
  return JSON.stringify(e);
}

function collectManual(out, store) {
  const manual = document.querySelectorAll("#manualInputs select");
  manual.forEach(sel => {
    const f = sel.dataset.file;
    const k = sel.value;
    if (!k) return;
    const entry = store[f][k];
    if (entry) out.push("\n[" + f + ":" + k + "]\n" + formatEntry(entry));
  });
}

async function init() {
  const manual = document.getElementById("manualInputs");
  const sceneSel = document.getElementById("sceneSel");
  const store = {};

  for (const f of files) {
    const data = await load(f);
    store[f] = data;
  }

  const scenes = store["scenes_prequel.json"];
  Object.keys(scenes).forEach(k => {
    const o = document.createElement("option");
    o.value = k;
    o.textContent = k;
    sceneSel.appendChild(o);
  });

  for (const f of files) {
    if (f === "scenes_prequel.json") continue;

    const wrap = document.createElement("div");
    wrap.className = "block";

    const label = document.createElement("label");
    label.textContent = f;
    wrap.appendChild(label);

    const sel = document.createElement("select");
    sel.dataset.file = f;

    const keys = Object.keys(store[f]);
    sel.appendChild(new Option("[none]",""));
    keys.forEach(k => sel.appendChild(new Option(k, k)));

    wrap.appendChild(sel);
    manual.appendChild(wrap);
  }

  document.getElementById("buildBtn").onclick = () => {
    const out = [];
    const sceneKey = sceneSel.value;
    const scene = scenes[sceneKey];

    if (scene) {
      out.push("=== SCENE: " + sceneKey + " ===");
      out.push(scene.summary || "");
      out.push("This is a 10 second vertical orientation clip for an 8k, high budget, modern-futuristic, prestige TV show");

      if (scene.setting) {
        const entry = store["settings.json"][scene.setting];
        if (entry) out.push("\n[SETTING]\n" + formatEntry(entry));
      }

      if (scene.region) {
        const entry = store["regions.json"][scene.region];
        if (entry) out.push("\n[REGION]\n" + formatEntry(entry));
      }

      if (scene.factions && scene.factions.length) {
        out.push("\n[FACTIONS]");
        scene.factions.forEach(k => {
          const e = store["factions.json"][k];
          if (e) out.push(formatEntry(e));
        });
      }

      if (scene.characters && scene.characters.length) {
        out.push("\n[CHARACTERS]");
        scene.characters.forEach(k => {
          const e = store["characters.json"][k];
          if (e) out.push(formatEntry(e));
        });
      }

      if (scene.dialog && scene.dialog.length) {
        out.push("\n[DIALOGUE]");
        scene.dialog.forEach(k => {
          const d = store["dialogue.json"][k];
          if (!d) return;
          const speaker = getHandle(d.speakerId, store["characters.json"]);
          const line = d.text || "";
          out.push(speaker + ": " + line);
        });
      }

      if (scene.direction && scene.direction.length) {
        out.push("\n[DIRECTION]");
        scene.direction.forEach(k => {
          const e = store["direction.json"][k];
          if (e) out.push(formatEntry(e));
        });
      }

      collectManual(out, store);
    } else {
      collectManual(out, store);
    }

    document.getElementById("out").textContent = out.join("\n").trim();
  };
}

init().catch(err => {
  document.getElementById("out").textContent = err.message;
});
</script>

</body>
</html>
